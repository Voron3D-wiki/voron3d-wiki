name: Affiliate Links (Autofix + Owner Approval for External Links)

on:
  pull_request_target:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  affiliate:
    # avoid infinite loop when workflow pushes a commit
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      # Checkout the PR HEAD so we can commit fixes back to the PR branch
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Configure git identity
        run: |
          git config user.name "affiliate-autofix[bot]"
          git config user.email "affiliate-autofix[bot]@users.noreply.github.com"

      # Fetch base so we can diff against it
      - name: Fetch base branch
        run: |
          git fetch origin "${{ github.event.pull_request.base.ref }}" --depth=1

      # Collect changed markdown files into changed_md.txt
      - name: Collect changed markdown files
        run: |
          BASE="origin/${{ github.event.pull_request.base.ref }}"
          git diff --name-only "$BASE"...HEAD -- '*.md' '*.markdown' > changed_md.txt || true
          echo "Changed markdown files:"
          cat changed_md.txt || true

      # Run autofix only on changed files
      - name: Autofix West3D + OneTwo3D affiliate links (changed files only)
        if: ${{ hashFiles('changed_md.txt') != '' }}
        run: |
          python3 .github/scripts/affiliate_links.py fix --files changed_md.txt

      # Push autofix only for same-repo PRs (forks can't be pushed to)
      - name: Commit and push affiliate fixes (same-repo PRs only)
        if: ${{ hashFiles('changed_md.txt') != '' && github.event.pull_request.head.repo.full_name == github.repository }}
        run: |
          if git diff --quiet; then
            echo "No autofix changes to commit."
            exit 0
          fi
          git add -A
          git commit -m "chore: auto-add affiliate tags"
          git push

      # Generate diff for markdown files (base -> head)
      - name: Generate diff for markdown files
        run: |
          BASE="origin/${{ github.event.pull_request.base.ref }}"
          git diff "$BASE"...HEAD -- '*.md' '*.markdown' > diff.txt || true
          echo "Diff lines:"
          wc -l diff.txt || true

      # Detect non-West3D / non-OneTwo3D external link changes
      - name: Detect non-affiliate external link changes
        id: links
        run: |
          # Writes ADDED/REMOVED to GITHUB_OUTPUT inside the script.
          # Don't fail here; we gate explicitly below.
          python3 .github/scripts/affiliate_links.py check --diff diff.txt || true

      # Decide whether to block merge:
      # - If no external link changes (excluding West3D/OneTwo3D): allow
      # - If there are changes and PR author is repo owner: allow
      # - Else: block + comment
      - name: Gate on external link changes
        id: gate
        run: |
          ADDED="${{ steps.links.outputs.ADDED }}"
          REMOVED="${{ steps.links.outputs.REMOVED }}"

          if [ -z "$ADDED" ] && [ -z "$REMOVED" ]; then
            echo "No non-affiliate external link changes."
            exit 0
          fi

          echo "Non-affiliate external link changes detected."

          # Allow if you authored the PR (assumes you are repo owner)
          if [ "${{ github.event.pull_request.user.login }}" = "${{ github.repository_owner }}" ]; then
            echo "PR authored by repo owner; allowing."
            exit 0
          fi

          echo "BLOCK=true" >> $GITHUB_OUTPUT
          exit 0

      - name: Comment with external link change report
        if: ${{ steps.gate.outputs.BLOCK == 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const addedRaw = `${{ steps.links.outputs.ADDED }}`.trim();
            const removedRaw = `${{ steps.links.outputs.REMOVED }}`.trim();
            const added = addedRaw ? addedRaw.split(/\s+/).filter(Boolean) : [];
            const removed = removedRaw ? removedRaw.split(/\s+/).filter(Boolean) : [];

            const owner = context.repo.owner;
            const author = context.payload.pull_request.user.login;

            let body = `## üîí External Link Changes Require Approval\n`;
            body += `This PR modifies **external links** (excluding West3D / OneTwo3D).\n\n`;
            body += `**PR author:** @${author}\n`;
            body += `**Approval required from:** @${owner}\n\n`;

            if (added.length) {
              body += "### üîµ Added Links\n" + added.map(u => `- ${u}`).join("\n") + "\n\n";
            }
            if (removed.length) {
              body += "### üî¥ Removed Links\n" + removed.map(u => `- ${u}`).join("\n") + "\n\n";
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Block merge until approved
        if: ${{ steps.gate.outputs.BLOCK == 'true' }}
        run: |
          echo "‚ùå External link changes detected ‚Äî owner approval required."
          exit 1
