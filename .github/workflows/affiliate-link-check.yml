name: Affiliate Links (Autofix + Policy)

on:
  pull_request_target:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  affiliate:
    # avoid infinite loop when workflow pushes a commit
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      # Checkout the PR HEAD so we can commit fixes back to the PR branch
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Configure git identity
        run: |
          git config user.name "affiliate-autofix[bot]"
          git config user.email "affiliate-autofix[bot]@users.noreply.github.com"

      # Fetch base so we can diff against it
      - name: Fetch base branch
        run: |
          git fetch origin "${{ github.event.pull_request.base.ref }}" --depth=1

      # Get list of changed markdown files only
      - name: Collect changed markdown files
        id: changed
        run: |
          BASE="origin/${{ github.event.pull_request.base.ref }}"
          git diff --name-only "$BASE"...HEAD -- '*.md' '*.markdown' > changed_md.txt || true
          echo "Changed markdown files:"
          cat changed_md.txt || true

          # multiline output for later steps
          echo "files<<EOF" >> $GITHUB_OUTPUT
          cat changed_md.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Run autofix only on changed files (not the whole docs tree)
      - name: Autofix affiliate links in changed files
        if: ${{ steps.changed.outputs.files != '' }}
        run: |
          python3 .github/scripts/affiliate_fix.py --files changed_md.txt

      - name: Commit and push affiliate fixes (if any)
        if: ${{ steps.changed.outputs.files != '' }}
        run: |
          if git diff --quiet; then
            echo "No autofix changes to commit."
            exit 0
          fi
          git add -A
          git commit -m "chore: auto-add affiliate tags"
          git push

      # Now do the "external link policy" check using only the PR diff
      - name: Generate diff for markdown files (base -> head)
        id: diff
        run: |
          BASE="origin/${{ github.event.pull_request.base.ref }}"
          git diff "$BASE"...HEAD -- '*.md' '*.markdown' > diff.txt || true
          echo "Diff lines:"
          wc -l diff.txt || true

      - name: Extract added/removed external links (policy)
        id: parse
        run: |
          chmod +x .github/scripts/extract-link.sh
          .github/scripts/extract-link.sh diff.txt

      - name: Fail if external links changed (policy)
        if: ${{ steps.parse.outputs.ADDED != '' || steps.parse.outputs.REMOVED != '' }}
        run: |
          echo "âŒ External link changes detected. Review required."
          echo ""
          echo "Added:"
          echo "${{ steps.parse.outputs.ADDED }}"
          echo ""
          echo "Removed:"
          echo "${{ steps.parse.outputs.REMOVED }}"
          exit 1

      - name: Comment with link change report
        if: ${{ steps.parse.outputs.ADDED != '' || steps.parse.outputs.REMOVED != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const addedRaw = `${{ steps.parse.outputs.ADDED }}`.trim();
            const removedRaw = `${{ steps.parse.outputs.REMOVED }}`.trim();
            const added = addedRaw ? addedRaw.split(/\s+/).filter(Boolean) : [];
            const removed = removedRaw ? removedRaw.split(/\s+/).filter(Boolean) : [];

            let body = "## ðŸ” External Link Changes Detected\n";
            body += "These changes must be reviewed **by the project owner** before merging.\n\n";

            if (added.length) {
              body += "### ðŸ”µ Added Links\n" + added.map(u => `- ${u}`).join("\n") + "\n\n";
            }
            if (removed.length) {
              body += "### ðŸ”´ Removed Links\n" + removed.map(u => `- ${u}`).join("\n") + "\n\n";
            }

            body += "â›” **This workflow blocks merging until reviewed.**";

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
