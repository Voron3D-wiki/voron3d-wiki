name: Affiliate Link Check

on:
  push:
    branches:
      - main
  pull_request_target:
    branches:
      - main

jobs:
  check-affiliate-links:
    name: Check External Link Changes
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------
      # 1) Safe checkout (use base branch to avoid read-only token issues)
      # ------------------------------------------------------
      - name: Checkout base branch safely
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0

      # ------------------------------------------------------
      # 2) Generate diff for Markdown files
      # ------------------------------------------------------
      - name: Generate diff for Markdown files
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD -- '*.md' '*.markdown' > diff.txt
          echo "Diff created:"
          cat diff.txt

      # ------------------------------------------------------
      # 3) Extract URLs using helper script
      # ------------------------------------------------------
      - name: Extract added/removed links
        id: parse
        run: |
          chmod +x .github/scripts/extract-link.sh
          .github/scripts/extract-link.sh diff.txt

      # ------------------------------------------------------
      # 4) Export script outputs
      # ------------------------------------------------------
      - name: Export Diff Outputs
        id: outputs
        run: |
          echo "added=${ADDED}" >> $GITHUB_OUTPUT
          echo "removed=${REMOVED}" >> $GITHUB_OUTPUT
        env:
          ADDED: ${{ steps.parse.outputs.ADDED }}
          REMOVED: ${{ steps.parse.outputs.REMOVED }}

      # ------------------------------------------------------
      # 5) Fail the check if any links changed
      # ------------------------------------------------------
      - name: Fail if any external links changed
        if: steps.outputs.outputs.added != '' || steps.outputs.outputs.removed != ''
        run: |
          echo "âŒ External link changes detected. Review required."
          exit 1

      # ------------------------------------------------------
      # 6) Comment on PR with a clean report
      # ------------------------------------------------------
      - name: Comment on PR about link changes
        if: steps.outputs.outputs.added != '' || steps.outputs.outputs.removed != ''
        uses: actions/github-script@v7
        with:
          script: |
            const added = `${{ steps.outputs.outputs.added }}`.trim().split(/\s+/).filter(Boolean);
            const removed = `${{ steps.outputs.outputs.removed }}`.trim().split(/\s+/).filter(Boolean);
            const modified = added.filter(a => removed.includes(a));

            let body = "## ðŸ” External Link Changes Detected\n";
            body += "These changes must be reviewed **by the project owner** before merging.\n\n";

            if (modified.length > 0) {
              body += "### ðŸŸ¡ Modified Links (Changed)\n";
              body += "| Old | New |\n|-----|-----|\n";
              modified.forEach(link => {
                body += `| ${link} | ${link} |\n`;
              });
              body += "\n";
            }

            if (added.length > 0) {
              body += "### ðŸ”µ Added Links\n";
              added.forEach(url => body += `- ${url}\n`);
              body += "\n";
            }

            if (removed.length > 0) {
              body += "### ðŸ”´ Removed Links\n";
              removed.forEach(url => body += `- ${url}\n`);
              body += "\n";
            }

            body += "â›” **The workflow has blocked merging until this change is approved.**";

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      # ------------------------------------------------------
      # 7) Auto-approve PRs from trusted contributor (amovfc)
      # ------------------------------------------------------
      - name: Auto-approve PRs from amovfc
        if: github.event.pull_request.user.login == 'amovfc'
        uses: hmarr/auto-approve-action@v3
        with:
          github-token: ${{ secrets.BOT_TOKEN }}
