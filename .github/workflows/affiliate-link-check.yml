name: Affiliate Link Check

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

  # Optional: keep this ONLY if you really need elevated perms on PRs from forks
  # (Be careful: pull_request_target runs in the context of the base repo)
  pull_request_target:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-affiliate-links:
    name: Check External Link Changes
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout safely for both PR types
      - name: Checkout code safely
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.base.ref || github.ref }}
          fetch-depth: 0

      # 2) Generate diff for markdown files (base -> head)
      - name: Generate diff for Markdown files
        id: diff
        run: |
          BASE_REF="${{ github.base_ref }}"
          if [ -z "$BASE_REF" ]; then
            # Fallback for safety (shouldn't happen for PR events)
            BASE_REF="main"
          fi

          git fetch origin "$BASE_REF"
          git diff "origin/$BASE_REF"...HEAD -- '*.md' '*.markdown' > diff.txt

          echo "Diff created:"
          wc -l diff.txt || true

      # 3) Extract + normalize links (West3D /3DWIKI + OneTwo3D wpam_id=9 ignored)
      - name: Extract added/removed links
        id: parse
        run: |
          chmod +x .github/scripts/extract-link.sh
          .github/scripts/extract-link.sh diff.txt

      # 4) Fail if any external links changed (true adds/removes only)
      - name: Fail if any external links changed
        if: ${{ steps.parse.outputs.ADDED != '' || steps.parse.outputs.REMOVED != '' }}
        run: |
          echo "âŒ External link changes detected. Review required."
          echo ""
          echo "Added:"
          echo "${{ steps.parse.outputs.ADDED }}"
          echo ""
          echo "Removed:"
          echo "${{ steps.parse.outputs.REMOVED }}"
          exit 1

      # 5) Comment on PR when link changes exist
      - name: Comment with link change report
        if: ${{ steps.parse.outputs.ADDED != '' || steps.parse.outputs.REMOVED != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const addedRaw = `${{ steps.parse.outputs.ADDED }}`.trim();
            const removedRaw = `${{ steps.parse.outputs.REMOVED }}`.trim();

            const added = addedRaw ? addedRaw.split(/\s+/).filter(Boolean) : [];
            const removed = removedRaw ? removedRaw.split(/\s+/).filter(Boolean) : [];

            let body = "## ðŸ” External Link Changes Detected\n";
            body += "These changes must be reviewed **by the project owner** before merging.\n\n";

            if (added.length > 0) {
              body += "### ðŸ”µ Added Links\n";
              body += added.map(u => `- ${u}`).join("\n") + "\n\n";
            }

            if (removed.length > 0) {
              body += "### ðŸ”´ Removed Links\n";
              body += removed.map(u => `- ${u}`).join("\n") + "\n\n";
            }

            body += "â›” **This workflow blocks merging until reviewed.**";

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      # 6) Optional: Auto-approve your own PRs using GitHub App
      # (Only makes sense if branch protection requires approval even for you)
      - name: Generate GitHub App token
        id: app-token
        if: ${{ github.event.pull_request.user.login == 'amovfc' }}
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}
          installation_id: ${{ secrets.APP_INSTALLATION_ID }}

      - name: Auto-approve PRs from amovfc
        if: ${{ github.event.pull_request.user.login == 'amovfc' }}
        uses: hmarr/auto-approve-action@v3
        with:
          github-token: ${{ steps.app-token.outputs.token }}
